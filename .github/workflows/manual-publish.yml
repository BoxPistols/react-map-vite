name: 手動パッケージ公開

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'パッケージのバージョン（例: 0.0.11）'
        required: true
        default: ''

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: チェックアウト
      uses: actions/checkout@v4

    - name: pnpmセットアップ
      uses: pnpm/action-setup@v2
      with:
        version: 8

    - name: Node.jsセットアップ
      uses: actions/setup-node@v4
      with:
        node-version: '20.13.1'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@boxpistols'

    - name: バージョン確認
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "現在のバージョン: $CURRENT_VERSION"
        echo "公開するバージョン: ${{ github.event.inputs.version }}"

        if [ "$CURRENT_VERSION" != "${{ github.event.inputs.version }}" ]; then
          echo "バージョンが一致しません。package.jsonを更新します。"
          sed -i "s/\"version\": \"$CURRENT_VERSION\"/\"version\": \"${{ github.event.inputs.version }}\"/" package.json
        fi

    - name: 依存パッケージのインストール
      run: pnpm install --no-frozen-lockfile

    - name: ライブラリのビルド
      run: pnpm run build:lib

    - name: パッケージの公開
      run: pnpm publish --no-git-checks
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 公開サマリー
      if: success()
      run: |
        echo "## パブリッシュ成功 :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "- パッケージ: $(node -p 'require("./package.json").name') v$(node -p 'require("./package.json").version')" >> $GITHUB_STEP_SUMMARY
        echo "- 公開日時: $(date)" >> $GITHUB_STEP_SUMMARY
